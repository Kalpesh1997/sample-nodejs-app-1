---
- name: Install python3, docker, docker-compose
  hosts: aws_ec2
  become: yes
  gather_facts: False
  tasks:
    - name: Ensure python3 and docker are installed
      vars:
        ansible_python_interpreter: /usr/bin/python
      yum:
        name:
          - python3
          - docker
        update_cache: yes
        state: present
    - name: Ensure docker compose is installed
      get_url:
        url: https://github.com/docker/compose/releases/download/v2.20.3/docker-compose-{{lookup('pipe', 'uname -s')}}-{{lookup('pipe', 'uname -m')}}
        dest: /usr/local/bin/docker-compose
        mode: +x
    - name: Ensure docker is started
      systemd:
        name: docker
        state: started
    - name: Ensure docker python module is installed
      pip:
        name:
          - docker
          - docker-compose

- name: Add user to docker group
  hosts: aws_ec2
  become: yes
  tasks:
    - name: Ensure user is added to docker group
      user:
        name: ec2-user
        groups: docker
        append: yes
    - name: Reconnect to server session
      meta: reset_connection

- name: Start container
  hosts: aws_ec2
  become: yes
  become_user: ec2-user
  tasks:
    - name: Log into ECR registry
      vars:
        ansible_python_interpreter: /usr/bin/python
      docker_login:
        registry_url: "246167819468.dkr.ecr.us-east-1.amazonaws.com"
        debug: yes
        username: "AWS"
        password: "eyJwYXlsb2FkIjoibWp4dHdyWk9keGFqRVFlMXZpRmpkTGlNdysxcDkvWGJ6d3BTVUdNY1FkYWhBUUUxbE9pb29qdHRqRUw2akpHd2RBSE93dzBxTGs3dGMvS2tLL2xtWTBZVTE3Sm9kdzhxZGpkclB3ZW5meDlFWVUyNk9ERUN4WHNDNmhCVU9RQjRPRndMUVlvMEpmUnRPamdKa3UvTCtzQk9hR1k3cU1XQzhyMWdneVdUbG4yOEdFbHpaa0RFU2pPSEVXL0ZnRlZTY3RSdEZtcDJVWWplSEJLcU9uMHh0Z2JPZEZ0ZnlzOERGdVVmMm5ONFp6OFFtUFhBT0hRUkVTSnkyd2o2dGg5OHpRQ1BhdTJLZjhidi93Mzh4blNYK05aeWQrS2g5c2V4b2o4RU9lRzUxODRMWHF5bEV6alJRL0JMY1B3b3IvTmcrekFBQm9xSXgvUTM0VDRWQ2pvNkRkeVIyTm1jT0dtaEhQb0lKOU5GbTQ4eHEzTGhLRUN3b2Y3SkQ0K2tXbHFIc09SdnpLQzBhQUY2ZENsWWlYSFpkVUZhM2xqeEVxejNBd1BsdVNFYjhVYkZJSStDd1lhVzU1K0hYeWpiazlNNTNHNUdVdjRTKytPTE1vbU9ic095YWVJOGt3bHM4NHoreFV0UGJuS0tDblR1OU5pVVc4NkptMkxIU29OcVFQcGEzQStERzdUV0xoY1N0MVhnTk4vYTF5ZDdKOS9RL2hxYmw4TUNxajlhOGNnaEJEZmF1M0FuVHV3MnJBTGcwNGw1RjZ0eG1OaFkyMzY0a2ZHWUZQZC9KNWlDbnhMZEdjaERBSEUyZ1AyZ2IxNHhNQXJWNkIzZDZQejdwQkcyVWoyeGttd1ZKVVlBcnVOb0plTDFLUjVWb2w0bWNQeTBLSFZXeWdiUDlZZW55Vlp3MGlRZzA1OGY0b1l4RXk3N0lYZU9ZbmwyWnRaaytjU0lnZm82V0lBWEhmSnVlakxUZWUzbDNNa0R2SnBDOVp2TUNkbXVNdjRYOEl0d0tZdmpYdERDc2ZnR0dUMTRLSzZ5K3VDZ245bXZPVmhXcmtFeW9HczVIM1I3a0hscTlMTlNKZnoxQ3J5Ym1tZmlCUHY2ODRBMndQVUVkZFJiTVJ5Wi9EdTVkaS94T01lU3NZa2hTbFBKUmhvOXhOVGttemJkM2x0ZUpXSGhSamxEQTR1WmUrb25vak9jWUh3Smc5alNoSG9vdFRzUmdJSzRySXpOeU15V2FrbVd4OERmb25ySWdMa0pLUGNhcE5acVNMd2ExeU43cU9ZSlc3QUo1a1JZN3ZveTVoVjFlQXgvMHFQZVBGbG0zYkZCUmJ0THRjK2ErK2F1Z2RzV3FPMW9DMmt0ZVdSaUVtTGo5N0RYRmY5Z1A2M29wWkRQcHFlMVVsemZuMWgvRnc9PSIsImRhdGFrZXkiOiJBUUVCQUhod20wWWFJU0plUnRKbTVuMUc2dXFlZWtYdW9YWFBlNVVGY2U5UnE4LzE0d0FBQUg0d2ZBWUpLb1pJaHZjTkFRY0dvRzh3YlFJQkFEQm9CZ2txaGtpRzl3MEJCd0V3SGdZSllJWklBV1VEQkFFdU1CRUVETG9IZDF3bnZFb1hta3QvMkFJQkVJQTdKOFFtTnVpREdTUHdac0ZEWVRRTXhhK1M4RVhiMHJ1ZVhQR1BRcFRRenRudWFNcnY4RW5rck9mVHl0d1praG4zL3RYbm9PdWNVbG0xdDhzPSIsInZlcnNpb24iOiIyIiwidHlwZSI6IkRBVEFfS0VZIiwiZXhwaXJhdGlvbiI6MTcwNjA3MTQ3NX0="
        reauthorize: yes

    - name: Ensure container is running
      vars:
        ansible_python_interpreter: /usr/bin/python
      docker_container:
        name: sample-nodejs-app-1
        state: started
        image: "246167819468.dkr.ecr.us-east-1.amazonaws.com/sample-nodejs-app-1:4.0"
        pull: true
        ports:
          - "3000:3000"
